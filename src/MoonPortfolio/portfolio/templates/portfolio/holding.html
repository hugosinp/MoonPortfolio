{% extends 'home/base_nonav.html' %}
{% load static %}
{% load humanize %}
{% load mathfilters %}

{% block styles %}
{% endblock %}

{% block title %}
MoonPortfolio | {{ current_portfolio.name }} Holdings
{% endblock %}

{% block horizontal_navabar %}
    {{ current_portfolio.name }} Dashboard
{% endblock %}


{% block body %}
    {% for holding in user_holdings %}
        {{ holding.asset_name }}
{% endfor %}
    
  <!-- ___________________________________________ROW 1___________________________________________-->
  <div class="row mt-4 mx-4">
    <!-- _____________________________Card 1_____________________________-->
    <div class="col-4 mt-3">
      <div class="card shadow" style="width: 100%; border-radius: 50px;">
        <div class="card-body m-3" id="group">
            <h3 class="card-title">
                {% for coin in coin_api %}
                    {% if coin.symbol|upper == current_holding.asset_name %}
                        {{ coin.name }} Balance <img src="{{ coin.image }}" style="height:30%; width:15%; object-fit: contain;" alt="Responsive image">
                    {% endif %}                
                {% endfor %}
            </h3>

            <div style="height: 400px;">
                <h1 class="fw-bold">
                ${{ current_holding.current_value|floatformat:"2" }}
                </h1>
                <h4>
                {{ current_holding.total_asset_amount|floatformat:"2" }} {{ current_holding.asset_name }}
                </h4>


                <div class="card card-body m-3" style="border-radius: 50px;">
                    <h3 class="card-title m-1">Total Profit/Loss</h3>
                    <h1 class="fw-bold m-1">${{ total.total__sum|floatformat:"2" }}</h1>
                </div>

                <div class="card card-body m-3" style="border-radius: 50px;">
                    <h3 class="card-title m-1">Total Invested</h3>
                    <h1 class="fw-bold m-1">${{ total.total__sum|floatformat:"2" }}</h1>
                </div>
            </div>




        </div>
      </div>
    </div>

    <div class="col mt-3">

      <div class="card shadow" style="width: 100%; border-radius: 50px;">
        <div class="card-body m-3">
          <h3 class="card-title">Transactions</h3>
          <div style="position: relative; height: 400px; overflow: auto; display: block;">
            <table class="table table-hover table-responsive" id="coins" cellspacing="0" width="100%">
              <thead>
                  <tr>
                      <th scope='col'>Name</th>
                      <th scope='col'>Price/24h Change</th>
                      <th scope='col'>Holdings</th>
                  </tr>
              </thead>

              <tbody>
                {% for holding in user_holdings %}
                  <tr>
                      <td class='align-middle'>
                      {% for coin in coin_data %}
                        {% if coin.symbol|upper == holding.asset_name %}
                          <a style="text-decoration: none; color: black;" href="{% url 'asset' coin.symbol|lower %}" target="_blank">
                            <img src={{ coin.image }} height='30' style="padding-right: 10%;">
                            <span class="fw-bold">{{ coin.name }}</span>
                            <span class="text-secondary">{{ holding.asset_name }}</span>
                          </a>
                        {% endif %}
                      {% endfor %}
                      </td>
                      
                      <td class='align-middle'>
                        {% for coin in coin_data %}
                          {% if coin.symbol|upper == holding.asset_name %}
                            ${{ coin.current_price|floatformat:"2" }}
                            {% if coin.price_change_percentage_24h >= 0 %}
                                <span class="text-success" style="color=green;">(+{{ coin.price_change_percentage_24h|floatformat:"2" }}%)</span>
                                <img src="{% static 'img/up.png' %}" alt="" width="15" height="15"> 
                            {% elif coin.price_change_percentage_24h < 0 %}
                                <span class="text-danger">({{ coin.price_change_percentage_24h|floatformat:"2" }}%)</span>
                                <img src="{% static 'img/down.png' %}" alt="" width="15" height="15"> 
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      </td>

                      <td class='align-middle'>
                        <a style="text-decoration: none; color: black;" href="{% url 'holding_details' current_portfolio.id holding.id %}" target="_blank">
                          <span class="">
                            {% for coin in coin_data %}
                              {% if coin.symbol|upper == holding.asset_name %}
                                ${{ holding.current_value|floatformat:"2" }}
                              {% endif %}
                            {% endfor %}
                          </span>
                          </br>
                          <span class="text-secondary"> 
                            {% for coin in coin_data %}
                              {% if coin.symbol|upper == holding.asset_name %}
                                {{ holding.total_asset_amount|floatformat:"2" }} {{ holding.asset_name }}
                              {% endif %}
                            {% endfor %}
                          </span>
                        </a>
                      </td>
                  </tr>
                {% endfor %}
              </tbody>

            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
  <!-- ___________________________________________END ROW 1___________________________________________-->

  <!-- ___________________________________________ROW 2___________________________________________-->
  <div class="row my-5 mx-4">

    <div class="col">
      <div class="card shadow-sm" style="width: 100%; height=400px;border-radius: 50px;">
        <div class="card-body m-3">
          <h3 class="card-title">
            Latest transactions <a class="float-end" href"" data-bs-toggle="modal" data-bs-target="#transactionHistoryModal">See all</a>
          </h3>
          
          <table class="table table-hover" id="coins" cellspacing="0" width="100%" >
            <thead>
                <tr>
                    <th scope='col'>Date</th>
                    <th scope='col'>Type</th>
                    <th scope='col'>Asset</th>
                    <th scope='col'>Amount</th>
                    <th scope='col'>Price Per Coin</th>
                    <th scope='col'>Total</th>
                </tr>
            </thead>
            <tbody>
                {% if transactions %}
                    {% for transaction in last_transactions %}
                        <tr>
                            <td class='align-middle'>{{ transaction.transaction_date }}</td>
                            <td class='align-middle'>{{ transaction.transaction_type }}</td>
                            <td class='align-middle'>{{ transaction.asset_name }}</td>
                            <td class='align-middle'>{{ transaction.amount }} {{ transaction.asset_name }}</td>
                            <td class='align-middle'>{{ transaction.price_per_coin }} $ </td>
                            <td class='align-middle'>{{ transaction.total|floatformat:"2" }} $</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
          </table>              
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card shadow-sm" style="width: 100%; height=400px; border-radius: 50px;">
        <div class="card-body m-2">
          <h3 class="card-title">Balance Overtime</h3>
          <canvas id="line-chart" width="400" height="380"></canvas>
          <script>
            new Chart(document.getElementById("line-chart"), {
              type: 'line',
              data: {
                labels: [1500,1600,1700,1750,1800,1850,1900,1950,1999,2050],
                datasets: [{ 
                    data: [86,114,106,106,107,111,133,221,783,2478],
                    label: null,
                    borderColor: "#3e95cd",
                    fill: false
                  }
                ]
              },
              options: {
                title: {
                  display: true,
                  text: 'World population per region (in millions)'
                }
              }
            });
          </script>      
        </div>
      </div>
    
    </div>

  </div>
  <!-- ___________________________________________END ROW 2___________________________________________-->
{% endblock %}