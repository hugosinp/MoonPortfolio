{% extends 'home/base_nonav.html' %}
{% load static %}
{% load humanize %}
{% load mathfilters %}

{% block styles %}
{% endblock %}

{% block title %}
  MoonPortfolio | {{ current_portfolio.name }} Dashboard
{% endblock %}


{% block horizontal_navabar %}
  {{ current_portfolio.name }} Dashboard
{% endblock %}

{% block body %}
  <!-- ___________________________________________ROW 1___________________________________________-->
  <div class="row mt-4 mx-4">
    <!-- _____________________________Card 1_____________________________-->
    <div class="col-4 mt-3">
      <div class="card shadow" style="width: 100%; border-radius: 50px;">
        <div class="card-body m-3" id="group">
          <h3 class="card-title">Current Balance ðŸ’°</h3>
          <div style="height: 450px;">
            <h1 class="fw-bold">
              ${{ current_balance.current_value__sum|floatformat:"2" }}
            </h1>

            <p>
              <a class="btn btn-primary" data-bs-toggle="collapse" href="#pieChart" role="button" aria-expanded="false" aria-controls="pieChart">
                Pie chart
              </a>
              <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#totals" aria-expanded="false" aria-controls="totals">
                Statistics
              </button>
            </p>
            <div class="collapse show" id="pieChart">
              <div class="card card-body shadow-sm" style="border-radius: 50px;">

                <canvas id="myChart" width="100%" height="100%" style="max-height: 400px; min-height: 400;"></canvas>
                <script>
                  
                  var config = {
                    type: 'doughnut',
                    data: {
                      datasets: [{
                        data: {{ holdings_percentages|safe }},
                        backgroundColor: [
                          '#6a4c93',
                          '#1982c4',
                          '#8ac926',
                          '#ffca3a',
                          '#ff595e',
                          '#70d6ff',
                          '#fd3535'
                        ],
                        hoverOffset: 4
                      }],
                      labels: {{ asset_names|safe }}
                    },
                    options: {
                      responsive: true
                    }
                  };

                  var myChart = new Chart(
                    document.getElementById('myChart'),
                    config
                  );
                </script>

              </div>
            </div>
          </div>

          <div class="collapse" id="totals">
            <div class="card card-body" style="border-radius: 50px;">
              <h3 class="card-title">Total Profit/Loss</h3>
            </div>
            <div class="card card-body" style="border-radius: 50px;">
              <h3 class="card-title">Total Invested</h3>
              <h1 class="fw-bold">${{ total.total__sum|floatformat:"2" }}</h1>
            </div>
          </div>


        </div>
      </div>
    </div>

    <div class="col mt-3">

      <div class="card shadow" style="width: 100%; border-radius: 50px;">
        <div class="card-body m-3">
          <h3 class="card-title">Your Assets ðŸ“ˆ</h3>
          <div style="position: relative; height: 450px; overflow: auto; display: block;">
            <table class="table table-hover table-responsive" id="coins" cellspacing="0" width="100%">
              <thead>
                  <tr>
                      <th scope='col'>Name</th>
                      <th scope='col'>Price/24h Change</th>
                      <th scope='col'>Holdings</th>
                  </tr>
              </thead>

              <tbody>
                {% for holding in user_holdings %}
                  <tr>
                      <td class='align-middle'>
                      {% for coin in coin_data %}
                        {% if coin.symbol|upper == holding.asset_name %}
                          <a style="text-decoration: none; color: black;" href="{% url 'asset' coin.symbol|lower %}" target="_blank">
                            <img src={{ coin.image }} height='30' style="padding-right: 10%;">
                            <span class="fw-bold">{{ coin.name }}</span>
                            <span class="text-secondary">{{ holding.asset_name }}</span>
                          </a>
                        {% endif %}
                      {% endfor %}
                      </td>
                      
                      <td class='align-middle'>
                        {% for coin in coin_data %}
                          {% if coin.symbol|upper == holding.asset_name %}
                            ${{ coin.current_price|floatformat:"2" }}
                            {% if coin.price_change_percentage_24h >= 0 %}
                                <span class="text-success" style="color=green;">(+{{ coin.price_change_percentage_24h|floatformat:"2" }}%)</span>
                                <img src="{% static 'img/up.png' %}" alt="" width="15" height="15"> 
                            {% elif coin.price_change_percentage_24h < 0 %}
                                <span class="text-danger">({{ coin.price_change_percentage_24h|floatformat:"2" }}%)</span>
                                <img src="{% static 'img/down.png' %}" alt="" width="15" height="15"> 
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      </td>

                      <td class='align-middle'>
                        <a style="text-decoration: none; color: black;" href="{% url 'holding_details' current_portfolio.id holding.id %}">
                          <span class="">
                            {% for coin in coin_data %}
                              {% if coin.symbol|upper == holding.asset_name %}
                                ${{ holding.current_value|floatformat:"2" }}
                              {% endif %}
                            {% endfor %}
                          </span>
                          </br>
                          <span class="text-secondary"> 
                            {% for coin in coin_data %}
                              {% if coin.symbol|upper == holding.asset_name %}
                                {{ holding.total_asset_amount|floatformat:"2" }} {{ holding.asset_name }}
                              {% endif %}
                            {% endfor %}
                          </span>
                        </a>
                      </td>
                  </tr>
                {% endfor %}
              </tbody>

            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
  <!-- ___________________________________________END ROW 1___________________________________________-->

  <!-- ___________________________________________ROW 2___________________________________________-->
  <div class="row my-5 mx-4">

    <div class="col">
      <div class="card shadow-sm" style="width: 100%; height=400px;border-radius: 50px;">
        <div class="card-body m-3">
          <h3 class="card-title">
            Latest transactions <a class="float-end" href"" data-bs-toggle="modal" data-bs-target="#transactionHistoryModal">See all</a>
          </h3>
          
          <table class="table table-hover" id="coins" cellspacing="0" width="100%" >
            <thead>
                <tr>
                    <th scope='col'>Date</th>
                    <th scope='col'>Type</th>
                    <th scope='col'>Asset</th>
                    <th scope='col'>Amount</th>
                    <th scope='col'>Price Per Coin</th>
                    <th scope='col'>Total</th>
                </tr>
            </thead>
            <tbody>
                {% if transactions %}
                    {% for transaction in last_transactions %}
                        <tr>
                            <td class='align-middle'>{{ transaction.transaction_date }}</td>
                            <td class='align-middle'>{{ transaction.transaction_type }}</td>
                            <td class='align-middle'>{{ transaction.asset_name }}</td>
                            <td class='align-middle'>{{ transaction.amount }} {{ transaction.asset_name }}</td>
                            <td class='align-middle'>{{ transaction.price_per_coin }} $ </td>
                            <td class='align-middle'>{{ transaction.total|floatformat:"2" }} $</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
          </table>              
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card shadow-sm" style="border-radius: 50px;">
        <div class="card-body m-2">
          <h3 class="card-title">Balance Overtime</h3>
    
        </div>
      </div>
    
    </div>

  </div>
  <!-- ___________________________________________END ROW 2___________________________________________-->
      

  <!-- ___________________________________________MODALS___________________________________________-->
  <!-- Modal -->
  <div class="modal fade" id="transactionHistoryModal" tabindex="-1" aria-labelledby="transactionHistoryModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
      <div class="modal-content"  style="border-radius: 50px;">
        <div class="modal-header">
          <h5 class="modal-title m-2" id="transactionHistoryModal">ðŸ“œ Transaction History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body text-center m-1">
          <table class="table table-hover" id="coins" cellspacing="0" width="100%" >
            <thead>
                <tr>
                    <th scope='col'>Date</th>
                    <th scope='col'>Type</th>
                    <th scope='col'>Asset</th>
                    <th scope='col'>Amount</th>
                    <th scope='col'>Price Per Coin</th>
                    <th scope='col'>Total</th>
                </tr>
            </thead>
            <tbody>
                {% if transactions %}
                    {% for transaction in transactions %}
                        <tr>
                            <td class='align-middle'>{{ transaction.transaction_date }}</td>
                            <td class='align-middle'>{{ transaction.transaction_type }}</td>
                            <td class='align-middle'>{{ transaction.asset_name }}</td>
                            <td class='align-middle'>{{ transaction.amount }} {{ transaction.asset_name }}</td>
                            <td class='align-middle'>{{ transaction.price_per_coin }} $ </td>
                            <td class='align-middle'>{{ transaction.total|floatformat:"2" }} $</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
          </table>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    $(function () {
      $("#id_transaction_date").datetimepicker({
        format: 'Y-m-d H:i',
        theme: 'dark',
        minDate:'2015/01/01'
      });
    });
  </script>
{% endblock %}